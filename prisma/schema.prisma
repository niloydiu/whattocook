generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ingredient {
  id                Int                @id @default(autoincrement())
  name_en           String
  name_bn           String
  img               String
  phonetic          String[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  recipeIngredients RecipeIngredient[]
  userAllergies     UserAllergy[]

  @@index([name_en])
  @@index([name_bn])
}

model Recipe {
  id           Int                @id @default(autoincrement())
  slug         String             @unique
  title_en     String
  title_bn     String
  image        String
  youtube_url  String
  youtube_id   String?
  cuisine      String
  category     String
  foodCategory String?            @default("Savory") // Dessert, Spicy, Sour, Sweet, Savory, Drinks, Appetizer, Soup, Salad
  difficulty   String
  prep_time    Int
  cook_time    Int
  servings     Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  blogContent  RecipeBlogContent?
  ingredients  RecipeIngredient[]
  steps        RecipeStep[]
  recipeReports RecipeReport[]
  favorites    Favorite[]

  @@index([slug])
  @@index([title_en])
  @@index([title_bn])
  @@index([cuisine])
  @@index([category])
  @@index([foodCategory])
}

model RecipeIngredient {
  id            Int        @id @default(autoincrement())
  recipe_id     Int
  ingredient_id Int
  quantity      String
  unit_en       String
  unit_bn       String
  notes_en      String?
  notes_bn      String?
  ingredient    Ingredient @relation(fields: [ingredient_id], references: [id])
  recipe        Recipe     @relation(fields: [recipe_id], references: [id], onDelete: Cascade)

  @@unique([recipe_id, ingredient_id])
  @@index([recipe_id])
  @@index([ingredient_id])
}

model RecipeStep {
  id             Int     @id @default(autoincrement())
  recipe_id      Int
  step_number    Int
  instruction_en String
  instruction_bn String
  timestamp      String?
  recipe         Recipe  @relation(fields: [recipe_id], references: [id], onDelete: Cascade)

  @@unique([recipe_id, step_number])
  @@index([recipe_id])
}

model RecipeBlogContent {
  id                       Int     @id @default(autoincrement())
  recipe_id                Int     @unique
  intro_en                 String
  intro_bn                 String
  what_makes_it_special_en String
  what_makes_it_special_bn String
  cooking_tips_en          String
  cooking_tips_bn          String
  serving_en               String
  serving_bn               String
  storage_en               String?
  storage_bn               String?
  full_blog_en             String
  full_blog_bn             String
  recipe                   Recipe  @relation(fields: [recipe_id], references: [id], onDelete: Cascade)

  @@index([recipe_id])
}

model Admin {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password_hash String
  email         String?  @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([username])
}

model RecipeRequest {
  id             Int      @id @default(autoincrement())
  requestType    String   // "submit", "by-ingredients", "by-name"
  status         String   @default("pending") // pending, approved, rejected
  
  // Common fields
  title          String?
  description    String?
  userEmail      String?
  userName       String?
  
  // For submit type
  recipeData     Json?    // Full recipe JSON
  
  // For by-ingredients type
  ingredients    String[] // Array of ingredient names
  
  // For by-name type
  recipeName     String?
  youtubeUrl     String?
  
  // Admin fields
  adminNotes     String?
  processedBy    String?
  processedAt    DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
  @@index([requestType])
  @@index([createdAt])
}

model RecipeReport {
  id             Int      @id @default(autoincrement())
  recipe_id      Int
  reporter_name  String?
  reporter_email String?
  reason         String
  details        String?
  status         String   @default("open") // open, reviewed, closed
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  recipe Recipe @relation(fields: [recipe_id], references: [id], onDelete: Cascade)

  @@index([recipe_id])
  @@index([status])
}

// Chat sessions stored per authenticated user. Messages saved as JSON array.
model ChatSession {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  messages  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Favorite {
  id        Int      @id @default(autoincrement())
  userId    String
  recipeId  Int
  createdAt DateTime @default(now())

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@index([userId])
}

// User-declared allergies. Can reference a known Ingredient (ingredientId) or store free-text names.
model UserAllergy {
  id           Int      @id @default(autoincrement())
  userId       String
  ingredientId Int?     // optional reference to Ingredient
  name_en      String   // canonical english name (or free-text)
  name_bn      String?  // optional bengali name
  createdAt    DateTime @default(now())

  ingredient Ingredient? @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([userId])
}
